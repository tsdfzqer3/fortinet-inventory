<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortinet åº«å­˜ç›£æ§ç³»çµ± - é›²ç«¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen p-6">
    <div id="app"></div>
    <script>
        // ============ é›²ç«¯è¨­å®šå€ ============
        const CLOUD_CONFIG = {
            supplierStock: 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://docs.google.com/spreadsheets/d/e/2PACX-1vTPXvFKAP0xi4WAW5EUaX-ZZt64Y8MJVZlPqpctzbNoQYsQmmHzt36MaMMby3d3qhDRZ4LN-wQAUc6p/pub?output=csv'),
            productCatalog: '', // è«‹å¡«å…¥æ–™ä»¶æ¸…å–®çš„ CSV ç™¼å¸ƒç¶²å€
            orderHistory: ''    // è«‹å¡«å…¥è¨‚å–®è¨˜éŒ„çš„ CSV ç™¼å¸ƒç¶²å€
        };

        let state={productCatalog:[],supplierStock:[],orderHistory:[],searchTerm:'',lowStockThreshold:10,filterZeroStock:false,lastSyncDate:null,supplierUpdateDate:null,orderUpdateDate:null,autoLoading:false,cloudSyncing:false};
        const storage={get:k=>JSON.parse(localStorage.getItem(k)||'null'),set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
        
        function loadData(){
            state.productCatalog=storage.get('forti-product-catalog')||[];
            state.supplierStock=storage.get('forti-supplier-stock')||[];
            state.orderHistory=storage.get('forti-order-history')||[];
            state.lastSyncDate=storage.get('forti-last-sync');
            state.supplierUpdateDate=storage.get('forti-supplier-update');
            state.orderUpdateDate=storage.get('forti-order-update');
            if(state.productCatalog.length>0)autoLoadSupplierStock();
        }
        
        function extractModel(name){
            if(!name)return null;
            name=name.toUpperCase();
            let match=name.match(/F[GS]-\d+[A-Z]?/i);
            if(match)return match[0].toUpperCase();
            match=name.match(/FORTISWITCH-(\d+[A-Z\-]+)/i);
            if(match)return'FS-'+match[1].toUpperCase();
            match=name.match(/FORTIAP-(\d+[A-Z]+)/i);
            if(match)return'FAP-'+match[1].toUpperCase();
            match=name.match(/FORTIWIFI-(\d+[A-Z]+)/i);
            if(match)return'FWF-'+match[1].toUpperCase();
            match=name.match(/FORTIGATE-(\d+[A-Z]+)/i);
            if(match)return'FG-'+match[1].toUpperCase();
            return null;
        }
        
        function getMergedInventory(){
            const modelOrderTotals={};
            state.productCatalog.forEach(p=>{
                if(!modelOrderTotals[p.model]){modelOrderTotals[p.model]=0;}
            });
            state.orderHistory.forEach(order=>{
                const product=state.productCatalog.find(p=>p.itemCode===order.itemCode);
                if(product&&product.model){modelOrderTotals[product.model]+=order.quantity;}
            });
            return state.productCatalog.map(p=>{
                const s=state.supplierStock.find(x=>x.model===p.model);
                const stockQty=s?.quantity??null;
                const orderedQty=state.orderHistory.filter(o=>o.itemCode===p.itemCode).reduce((sum,o)=>sum+o.quantity,0);
                const modelTotalOrdered=modelOrderTotals[p.model]||0;
                const remainingQty=stockQty!==null?stockQty-modelTotalOrdered:null;
                return{...p,stockQty:stockQty,orderedQty:orderedQty,modelTotalOrdered:modelTotalOrdered,remainingQty:remainingQty,inTransit:s?.inTransit||'',stockNotes:s?.notes||''};
            });
        }
        
        // ============ é›²ç«¯åŒæ­¥åŠŸèƒ½ ============
        async function syncFromCloud(){
            state.cloudSyncing=true;
            render();
            let successCount=0;
            try{
                // åŒæ­¥å» å•†åº«å­˜
                await autoLoadSupplierStock();
                successCount++;
                
                // åŒæ­¥æ–™ä»¶æ¸…å–®ï¼ˆå¦‚æœæœ‰è¨­å®šç¶²å€ï¼‰
                if(CLOUD_CONFIG.productCatalog){
                    await loadProductCatalogFromCloud();
                    successCount++;
                }
                
                // åŒæ­¥è¨‚å–®è¨˜éŒ„ï¼ˆå¦‚æœæœ‰è¨­å®šç¶²å€ï¼‰
                if(CLOUD_CONFIG.orderHistory){
                    await loadOrderHistoryFromCloud();
                    successCount++;
                }
                
                alert('âœ“ é›²ç«¯åŒæ­¥å®Œæˆï¼\næˆåŠŸåŒæ­¥ '+successCount+' é …è³‡æ–™');
            }catch(error){
                alert('é›²ç«¯åŒæ­¥å¤±æ•—ï¼š'+error.message);
            }finally{
                state.cloudSyncing=false;
                render();
            }
        }
        
        async function loadProductCatalogFromCloud(){
            const response=await fetch(CLOUD_CONFIG.productCatalog);
            if(!response.ok)throw new Error('ç„¡æ³•è¼‰å…¥æ–™ä»¶æ¸…å–®');
            const csvText=await response.text();
            const lines=csvText.trim().split('\n');
            const products=[];
            for(let i=1;i<lines.length;i++){
                const cells=lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g)||[];
                const cleanCells=cells.map(s=>s.replace(/^"|"$/g,'').trim());
                const itemCode=cleanCells[0];
                const productName=cleanCells[1];
                const model=cleanCells[2];
                const specs=cleanCells[3]||'';
                const notes=cleanCells[4]||'';
                if(itemCode&&productName&&model){
                    products.push({
                        id:`${itemCode}-${Date.now()}-${i}`,
                        itemCode:itemCode,
                        productName:productName,
                        model:model,
                        specs:specs,
                        notes:notes,
                        order:i
                    });
                }
            }
            if(products.length>0){
                state.productCatalog=products;
                storage.set('forti-product-catalog',products);
            }
        }
        
        async function loadOrderHistoryFromCloud(){
            const response=await fetch(CLOUD_CONFIG.orderHistory);
            if(!response.ok)throw new Error('ç„¡æ³•è¼‰å…¥è¨‚å–®è¨˜éŒ„');
            const csvText=await response.text();
            const lines=csvText.trim().split('\n');
            const orders=[];
            for(let i=1;i<lines.length;i++){
                const cells=lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g)||[];
                const cleanCells=cells.map(s=>s.replace(/^"|"$/g,'').trim());
                const itemCode=cleanCells[0];
                const productName=cleanCells[1];
                const model=cleanCells[2];
                const quantity=parseInt(cleanCells[3])||0;
                const poNumber=cleanCells[4]||'';
                const notes=cleanCells[5]||'';
                const timestamp=cleanCells[6]||new Date().toISOString();
                if(itemCode&&quantity>0){
                    orders.push({
                        id:Date.now()+i,
                        itemCode:itemCode,
                        productName:productName,
                        model:model,
                        quantity:quantity,
                        poNumber:poNumber,
                        notes:notes,
                        timestamp:timestamp
                    });
                }
            }
            if(orders.length>0){
                state.orderHistory=orders;
                state.orderUpdateDate=new Date().toISOString();
                storage.set('forti-order-history',orders);
                storage.set('forti-order-update',state.orderUpdateDate);
            }
        }
        
        async function exportToCSV(type){
            let csvContent='';
            let filename='';
            if(type==='catalog'){
                csvContent='æ–™è™Ÿ,å“å,å‹è™Ÿ,è¦æ ¼,å‚™è¨»\n';
                state.productCatalog.forEach(item=>{
                    csvContent+=`${item.itemCode},"${item.productName}",${item.model},"${item.specs||''}","${item.notes||''}"\n`;
                });
                filename='æ–™ä»¶æ¸…å–®_'+new Date().toISOString().split('T')[0]+'.csv';
            }else if(type==='orders'){
                csvContent='æ–™è™Ÿ,å“å,å‹è™Ÿ,æ•¸é‡,POå–®è™Ÿ,å‚™è¨»,æ™‚é–“æˆ³è¨˜\n';
                state.orderHistory.forEach(order=>{
                    csvContent+=`${order.itemCode},"${order.productName}",${order.model},${order.quantity},"${order.poNumber||''}","${order.notes||'"}","${order.timestamp}"\n`;
                });
                filename='è¨‚å–®è¨˜éŒ„_'+new Date().toISOString().split('T')[0]+'.csv';
            }
            const blob=new Blob(['\ufeff'+csvContent],{type:'text/csv;charset=utf-8;'});
            const link=document.createElement('a');
            link.href=URL.createObjectURL(blob);
            link.download=filename;
            link.click();
        }
        
        async function autoLoadSupplierStock(){
            if(state.autoLoading)return;
            state.autoLoading=true;
            render();
            try{
                const response=await fetch(CLOUD_CONFIG.supplierStock);
                if(!response.ok)throw new Error('ç„¡æ³•è¼‰å…¥CSV');
                const csvText=await response.text();
                const lines=csvText.trim().split('\n');
                const stock=[];
                const firstLine=lines[0];
                const updateDateMatch=firstLine.match(/\d{4}\/\d{1,2}\/\d{1,2}/);
                const supplierDate=updateDateMatch?updateDateMatch[0]:null;
                for(let i=1;i<lines.length;i++){
                    const cells=lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g)||[];
                    const cleanCells=cells.map(s=>s.replace(/^"|"$/g,'').trim());
                    const model=cleanCells[0];
                    const stockStr=cleanCells[1];
                    const inTransit=cleanCells[2]||'';
                    const notes=cleanCells[4]||'';
                    if(model&&stockStr&&model!=='å‹è™Ÿ'){
                        const quantity=parseInt(stockStr)||0;
                        stock.push({id:`${model}-${Date.now()}-${i}`,model:model,quantity:quantity,inTransit:inTransit,notes:notes});
                    }
                }
                if(stock.length>0){
                    state.supplierStock=stock;
                    storage.set('forti-supplier-stock',stock);
                    state.lastSyncDate=new Date().toISOString();
                    storage.set('forti-last-sync',state.lastSyncDate);
                    if(supplierDate){
                        state.supplierUpdateDate=supplierDate;
                        storage.set('forti-supplier-update',supplierDate);
                    }
                    if(!state.cloudSyncing){
                        alert('æˆåŠŸè‡ªå‹•è¼‰å…¥å» å•†åº«å­˜ï¼š'+stock.length+' é …\nå» å•†æ›´æ–°æ—¥æœŸï¼š'+(supplierDate||'æœªçŸ¥'));
                    }
                    render();
                }else{
                    alert('ç„¡æ³•è§£æCSVè³‡æ–™');
                }
            }catch(error){
                alert('è‡ªå‹•è¼‰å…¥å¤±æ•—ï¼š'+error.message);
            }finally{
                state.autoLoading=false;
                render();
            }
        }
        
        function handleStockSync(){
            if(confirm('ç¢ºå®šè¦é‡æ–°è¼‰å…¥å» å•†åº«å­˜å—ï¼Ÿ\né€™æœƒå¾ Google Sheets æŠ“å–æœ€æ–°è³‡æ–™ã€‚')){
                autoLoadSupplierStock();
            }
        }
        
        function handleCatalogExcelUpload(e){
            const file=e.target.files[0];
            if(!file)return;
            const reader=new FileReader();
            reader.onload=function(event){
                try{
                    const data=new Uint8Array(event.target.result);
                    const workbook=XLSX.read(data,{type:'array',codepage:65001});
                    const firstSheet=workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1,raw:false,defval:''});
                    processCatalogExcelData(jsonData);
                }catch(error){
                    alert('Excelæª”æ¡ˆè®€å–å¤±æ•—ï¼š'+error.message);
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value='';
        }
        
        function processCatalogExcelData(data){
            const existingCatalog=state.productCatalog;
            const newItems=[];
            const updatedItems=[];
            const skippedItems=[];
            const existingItemCodes=new Set(existingCatalog.map(p=>p.itemCode));
            for(let i=1;i<data.length;i++){
                const row=data[i];
                let itemCode=row[0];
                let productName=row[1];
                const specs=(row.length>7?row[7]:'')||'';
                if(typeof itemCode==='string')itemCode=itemCode.trim();
                else if(itemCode)itemCode=String(itemCode).trim();
                if(typeof productName==='string')productName=productName.trim();
                else if(productName)productName=String(productName).trim();
                let finalItemCode;
                if(!itemCode||itemCode===''||itemCode==='æ–™è™Ÿ'){
                    finalItemCode=`æœªç”³è«‹-${Date.now()}-${i}`;
                }else{
                    finalItemCode=itemCode;
                }
                if(productName&&productName!=='å“å'){
                    const model=extractModel(productName);
                    if(model){
                        if(!finalItemCode.startsWith('æœªç”³è«‹')&&existingItemCodes.has(finalItemCode)){
                            skippedItems.push(finalItemCode);
                            continue;
                        }
                        const newItem={id:`${finalItemCode}-${Date.now()}-${i}`,itemCode:finalItemCode,productName,model,specs:specs||'',notes:'',order:i};
                        newItems.push(newItem);
                        if(!finalItemCode.startsWith('æœªç”³è«‹')){
                            existingItemCodes.add(finalItemCode);
                        }
                    }
                }
            }
            const mergedCatalog=[...existingCatalog,...newItems];
            if(newItems.length>0||updatedItems.length>0){
                state.productCatalog=mergedCatalog;
                storage.set('forti-product-catalog',mergedCatalog);
                let message='æ–™ä»¶ç¶­è­·å®Œæˆï¼\n';
                message+=`æ–°å¢ï¼š${newItems.length} é …\n`;
                message+=`ç•¥éé‡è¤‡ï¼š${skippedItems.length} é …\n`;
                message+=`ç¸½è¨ˆï¼š${mergedCatalog.length} é …\n\n`;
                message+='ğŸ’¡ æç¤ºï¼šåˆ¥å¿˜äº†ä½¿ç”¨ã€ŒåŒ¯å‡ºæ–™ä»¶CSVã€ä¸Šå‚³åˆ° Google Sheets';
                if(skippedItems.length>0&&skippedItems.length<=5){
                    message+='\n\nç•¥éçš„æ–™è™Ÿï¼š\n'+skippedItems.join('\n');
                }else if(skippedItems.length>5){
                    message+='\n\nç•¥éçš„æ–™è™Ÿï¼š\n'+skippedItems.slice(0,5).join('\n')+'\n...ç­‰'+skippedItems.length+'é …';
                }
                alert(message);
                render();
            }else{
                alert('æœªèƒ½åŒ¯å…¥ä»»ä½•æ–™ä»¶');
            }
        }
        
        function handleExcelUpload(e){
            const file=e.target.files[0];
            if(!file)return;
            const reader=new FileReader();
            reader.onload=function(event){
                try{
                    const data=new Uint8Array(event.target.result);
                    const workbook=XLSX.read(data,{type:'array',codepage:65001});
                    const firstSheet=workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1,raw:false,defval:''});
                    processExcelData(jsonData);
                }catch(error){
                    alert('Excelæª”æ¡ˆè®€å–å¤±æ•—ï¼š'+error.message);
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value='';
        }
        
        function processExcelData(data){
            const merged=getMergedInventory();
            let successCount=0;
            let failedItems=[];
            for(let i=1;i<data.length;i++){
                const row=data[i];
                const orderDate=row[1];
                const poNumber=row[8];
                const itemCode=row[9]?.toString().trim();
                const productName=row[10];
                const quantity=parseInt(row[11]);
                if(!itemCode||!quantity||isNaN(quantity)){
                    continue;
                }
                const product=merged.find(p=>p.itemCode===itemCode);
                if(product){
                    const order={id:Date.now()+i,itemCode:itemCode,productName:productName||product.productName,model:product.model,quantity:quantity,poNumber:poNumber?.toString()||'',notes:'æ‰¹æ¬¡åŒ¯å…¥-'+(orderDate||''),timestamp:new Date().toISOString()};
                    state.orderHistory.push(order);
                    successCount++;
                }else{
                    failedItems.push(itemCode);
                }
            }
            if(successCount>0){
                state.orderUpdateDate=new Date().toISOString();
                storage.set('forti-order-history',state.orderHistory);
                storage.set('forti-order-update',state.orderUpdateDate);
                let message='æˆåŠŸåŒ¯å…¥'+successCount+'ç­†è¨‚å–®ï¼\n\n';
                message+='ğŸ’¡ æç¤ºï¼šåˆ¥å¿˜äº†ä½¿ç”¨ã€ŒåŒ¯å‡ºè¨‚å–®CSVã€ä¸Šå‚³åˆ° Google Sheets';
                if(failedItems.length>0){
                    message+='\n\næ‰¾ä¸åˆ°ä»¥ä¸‹æ–™è™Ÿï¼š\n'+failedItems.slice(0,5).join('\n');
                    if(failedItems.length>5){
                        message+='\n...ç­‰'+failedItems.length+'é …';
                    }
                }
                alert(message);
                render();
            }else{
                alert('æœªèƒ½åŒ¯å…¥ä»»ä½•è¨‚å–®');
            }
        }
        
        function clearAllOrders(){
            if(confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰æ¡è³¼è¨‚å–®è¨˜éŒ„ï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')){
                if(confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰è¨‚å–®å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')){
                    state.orderHistory=[];
                    state.orderUpdateDate=null;
                    storage.set('forti-order-history',[]);
                    storage.set('forti-order-update',null);
                    alert('âœ“ å·²æ¸…é™¤æ‰€æœ‰è¨‚å–®è¨˜éŒ„');
                    render();
                }
            }
        }
        
        function clearAllCatalog(){
            if(confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰æ–™ä»¶è³‡æ–™ï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')){
                if(confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰æ–™ä»¶å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')){
                    state.productCatalog=[];
                    storage.set('forti-product-catalog',[]);
                    alert('âœ“ å·²æ¸…é™¤æ‰€æœ‰æ–™ä»¶è³‡æ–™');
                    render();
                }
            }
        }
        
        function updateNotes(itemCode,notes){
            state.productCatalog=state.productCatalog.map(item=>item.itemCode===itemCode?{...item,notes:notes}:item);
            storage.set('forti-product-catalog',state.productCatalog);
        }
        
        function render(){
            const merged=getMergedInventory();
            const filtered=merged.filter(item=>{
                const search=state.searchTerm.toLowerCase();
                const match=item.itemCode.toLowerCase().includes(search)||item.productName.toLowerCase().includes(search)||item.model.toLowerCase().includes(search);
                const stock=!state.filterZeroStock||item.stockQty===null||item.stockQty>0;
                return match&&stock;
            });
            const zeroStock=merged.filter(i=>i.stockQty===0).length;
            const lowStock=merged.filter(i=>i.stockQty>0&&i.stockQty<=state.lowStockThreshold).length;
            const cloudConfigured=CLOUD_CONFIG.productCatalog&&CLOUD_CONFIG.orderHistory;
            document.getElementById('app').innerHTML=`<div class="max-w-[1600px] mx-auto"><div class="bg-white rounded-lg shadow-lg p-6 mb-6"><h1 class="text-3xl font-bold text-slate-800 mb-2">Fortinet ç”¢å“åº«å­˜ç›£æ§ <span class="text-sm font-normal text-blue-600">â˜ï¸ é›²ç«¯ç‰ˆ</span></h1><p class="text-slate-600 mb-4">å…¬å¸æ–™ä»¶ x å» å•†åº«å­˜å³æ™‚å°æ‡‰ | è³‡æ–™åŒæ­¥è‡³ Google Sheets</p><div class="grid grid-cols-4 gap-4 text-sm mb-4"><div><span class="text-slate-500">å» å•†æ›´æ–°ï¼š</span><strong>${state.supplierUpdateDate||'æœªçŸ¥'}</strong></div><div><span class="text-slate-500">åº«å­˜åŒæ­¥ï¼š</span><strong>${state.lastSyncDate?new Date(state.lastSyncDate).toLocaleString('zh-TW'):'æœªåŒæ­¥'}</strong></div><div><span class="text-slate-500">è¨‚å–®æ›´æ–°ï¼š</span><strong>${state.orderUpdateDate?new Date(state.orderUpdateDate).toLocaleString('zh-TW'):'æœªåŒ¯å…¥'}</strong></div><div>${!state.lastSyncDate||(new Date()-new Date(state.lastSyncDate))>604800000?'<span class="text-orange-600 font-bold">éœ€è¦æ›´æ–°</span>':''}</div></div>${!cloudConfigured?'<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 text-sm"><p class="font-bold text-yellow-800 mb-2">âš ï¸ é›²ç«¯åŒæ­¥æœªè¨­å®š</p><p class="text-yellow-700">è«‹åœ¨ç¨‹å¼ç¢¼çš„ CLOUD_CONFIG ä¸­å¡«å…¥æ–™ä»¶æ¸…å–®å’Œè¨‚å–®è¨˜éŒ„çš„ Google Sheets CSV ç¶²å€ï¼Œå³å¯å•Ÿç”¨å®Œæ•´é›²ç«¯åŒæ­¥åŠŸèƒ½ã€‚</p></div>':''}</div><div class="grid grid-cols-4 gap-4 mb-6"><div class="bg-white rounded-lg shadow p-6"><div class="text-slate-600 text-sm">å…¬å¸æ–™ä»¶æ•¸</div><div class="text-3xl font-bold text-slate-800">${state.productCatalog.length}</div></div><div class="bg-white rounded-lg shadow p-6"><div class="text-slate-600 text-sm">ç„¡åº«å­˜</div><div class="text-3xl font-bold text-red-600">${zeroStock}</div></div><div class="bg-white rounded-lg shadow p-6"><div class="text-slate-600 text-sm">ä½åº«å­˜</div><div class="text-3xl font-bold text-orange-600">${lowStock}</div></div><div class="bg-white rounded-lg shadow p-6"><div class="text-slate-600 text-sm">è¨‚å–®æ•¸</div><div class="text-3xl font-bold text-green-600">${state.orderHistory.length}</div></div></div><div class="bg-white rounded-lg shadow-lg p-6 mb-6"><div class="flex gap-4 mb-4 flex-wrap"><input type="text" placeholder="æœå°‹æ–™è™Ÿã€å“åæˆ–å‹è™Ÿ..." value="${state.searchTerm}" oninput="state.searchTerm=this.value;render();" class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg"><label class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap cursor-pointer">åŒ¯å…¥æ–™ä»¶Excel<input type="file" accept=".xlsx,.xls" onchange="handleCatalogExcelUpload(event)" class="hidden"></label><button onclick="handleStockSync()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 whitespace-nowrap flex items-center gap-2">${state.autoLoading?'<span class="animate-spin">âŸ³</span>':''} é‡æ–°è¼‰å…¥åº«å­˜</button><label class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 whitespace-nowrap cursor-pointer">ä¸Šå‚³æ¡è³¼è¨‚å–®<input type="file" accept=".xlsx,.xls" onchange="handleExcelUpload(event)" class="hidden"></label><button onclick="syncFromCloud()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap flex items-center gap-2" ${!cloudConfigured?'disabled title="è«‹å…ˆè¨­å®šé›²ç«¯ç¶²å€"':''}>${state.cloudSyncing?'<span class="animate-spin">âŸ³</span>':'â˜ï¸'} å¾é›²ç«¯åŒæ­¥</button></div><div class="flex gap-4 mb-4 flex-wrap"><button onclick="exportToCSV('catalog')" class="px-3 py-2 bg-indigo-500 text-white text-sm rounded hover:bg-indigo-600">ğŸ“¤ åŒ¯å‡ºæ–™ä»¶CSV</button><button onclick="exportToCSV('orders')" class="px-3 py-2 bg-indigo-500 text-white text-sm rounded hover:bg-indigo-600">ğŸ“¤ åŒ¯å‡ºè¨‚å–®CSV</button><button onclick="clearAllCatalog()" class="px-3 py-2 bg-red-500 text-white text-xs rounded hover:bg-red-600 whitespace-nowrap" title="æ¸…é™¤æ‰€æœ‰æ–™ä»¶è³‡æ–™">ğŸ—‘ï¸ æ¸…é™¤æ–™ä»¶</button><button onclick="clearAllOrders()" class="px-3 py-2 bg-red-500 text-white text-xs rounded hover:bg-red-600 whitespace-nowrap" title="æ¸…é™¤æ‰€æœ‰æ¡è³¼è¨‚å–®è¨˜éŒ„">ğŸ—‘ï¸ æ¸…é™¤è¨‚å–®</button></div><div class="flex gap-6 text-sm flex-wrap"><div class="flex items-center gap-2"><span>ä½åº«å­˜é–€æª»ï¼š</span><input type="number" value="${state.lowStockThreshold}" onchange="state.lowStockThreshold=parseInt(this.value)||0;render();" class="w-20 px-2 py-1 border rounded"><span>ä»¶</span></div><label class="flex items-center gap-2"><input type="checkbox" ${state.filterZeroStock?'checked':''} onchange="state.filterZeroStock=this.checked;render();"> éš±è—ç„¡åº«å­˜</label></div></div><div class="bg-white rounded-lg shadow-lg overflow-hidden"><div class="overflow-x-auto"><table class="w-full table-fixed"><thead class="bg-gradient-to-r from-slate-700 to-slate-600 text-white"><tr><th class="px-4 py-3 text-left text-xs font-semibold" style="width: 140px">æ–™è™Ÿ</th><th class="px-4 py-3 text-left text-xs font-semibold" style="width: 280px">å“å</th><th class="px-4 py-3 text-center text-xs font-semibold" style="width: 90px">å‹è™Ÿ</th><th class="px-4 py-3 text-center text-xs font-semibold" style="width: 70px">åº«å­˜</th><th class="px-4 py-3 text-center text-xs font-semibold" style="width: 80px">æ­¤æ–™è™Ÿ<br>å·²ä¸‹å–®</th><th class="px-4 py-3 text-center text-xs font-semibold" style="width: 80px">å‹è™Ÿ<br>ç¸½ä¸‹å–®</th><th class="px-4 py-3 text-center text-xs font-semibold" style="width: 70px">å‰©é¤˜</th><th class="px-4 py-3 text-left text-xs font-semibold">å‚™è¨»</th></tr></thead><tbody class="divide-y divide-slate-200">${filtered.length?filtered.map(i=>{const stockColor=i.stockQty===null?'':i.stockQty===0?'bg-red-100 text-red-700':i.stockQty<=state.lowStockThreshold?'bg-orange-100 text-orange-700':i.stockQty<=state.lowStockThreshold*2?'bg-yellow-100 text-yellow-700':'bg-green-100 text-green-700';const remainingColor=i.remainingQty===null?'':i.remainingQty<=0?'bg-red-100 text-red-700':i.remainingQty<=state.lowStockThreshold?'bg-orange-100 text-orange-700':i.remainingQty<=state.lowStockThreshold*2?'bg-yellow-100 text-yellow-700':'bg-green-100 text-green-700';return`<tr class="hover:bg-blue-50 transition-colors"><td class="px-4 py-3"><span class="font-mono text-xs font-semibold ${i.itemCode.startsWith('æœªç”³è«‹')?'text-red-600':'text-slate-800'}">${i.itemCode.startsWith('æœªç”³è«‹')?'æœªç”³è«‹':i.itemCode}</span></td><td class="px-4 py-3"><div class="text-xs text-slate-700 leading-tight" title="${i.productName}">${i.productName}</div></td><td class="px-4 py-3 text-center"><span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-bold">${i.model}</span></td><td class="px-4 py-3 text-center">${i.stockQty===null?'<span class="text-slate-400 text-xs">-</span>':`<span class="inline-block px-2 py-1 rounded text-xs font-bold ${stockColor}">${i.stockQty}</span>`}</td><td class="px-4 py-3 text-center"><span class="inline-block px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs font-semibold">${i.orderedQty||0}</span></td><td class="px-4 py-3 text-center"><span class="inline-block px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold">${i.modelTotalOrdered||0}</span></td><td class="px-4 py-3 text-center">${i.remainingQty===null?'<span class="text-slate-400 text-xs">-</span>':`<span class="inline-block px-2 py-1 rounded text-xs font-bold ${remainingColor}">${i.remainingQty}</span>`}</td><td class="px-4 py-3"><input type="text" value="${i.notes||''}" onchange="updateNotes('${i.itemCode}',this.value);render();" placeholder="è¼¸å…¥å‚™è¨»..." class="w-full px-2 py-1 text-xs border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"></td></tr>`;}).join(''):`<tr><td colspan="8" class="px-6 py-16 text-center"><div class="text-slate-400"><svg class="mx-auto h-12 w-12 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg><p class="text-lg font-medium">${state.productCatalog.length?'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™':'è«‹å…ˆåŒ¯å…¥æ–™ä»¶æ¸…å–®æˆ–å¾é›²ç«¯åŒæ­¥'}</p></div></td></tr>`}</tbody></table></div></div></div>`;
        }
        
        loadData();
        render();
    </script>
</body>
</html>
